name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # 允许手动触发

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: release  # 使用环境保护规则
    
    steps:
    - name: 🛎️ Checkout code
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        pip install -r requirements.txt
        
    - name: 🔍 Run tests
      run: |
        if [ -f "validate_project.py" ]; then
          python validate_project.py
        fi
        
    - name: 🔨 Build package
      run: python -m build
      
    - name: 🔍 Check package
      run: python -m twine check dist/*
      
    - name: 🚀 Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: python -m twine upload dist/*
      
    - name: 📝 Create release notes
      run: |
        VERSION=$(python -c "import re; content=open('pyproject.toml').read(); print(re.search(r'version\s*=\s*[\"\'](.*?)[\"\']', content).group(1))")
        echo "# Release v${VERSION}" > release_notes.md
        echo "" >> release_notes.md
        echo "🎉 Successfully published to PyPI!" >> release_notes.md
        echo "" >> release_notes.md
        echo "## 📦 Installation" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "pip install llm-flow-engine==${VERSION}" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## 🔗 Links" >> release_notes.md
        echo "- [PyPI Package](https://pypi.org/project/llm-flow-engine/${VERSION}/)" >> release_notes.md
        echo "- [GitHub Release](https://github.com/liguobao/llm-flow-engine/releases/tag/v${VERSION})" >> release_notes.md
      env:
        PYTHONIOENCODING: utf-8
        
    - name: 📤 Upload release notes
      uses: actions/upload-artifact@v3
      with:
        name: release-notes
        path: release_notes.md
